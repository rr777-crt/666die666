<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–æ—á–Ω–∞—è –ò–≥—Ä–∞</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 0;
            color: #333;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .resources {
            display: flex;
            gap: 20px;
        }
        
        .resource {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .main-content {
            display: flex;
            gap: 20px;
        }
        
        .game-area {
            flex: 3;
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .blocks-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .block {
            height: 200px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            background-color: #f9f9f9;
        }
        
        .block:hover {
            border-color: #3498db;
        }
        
        .block.active {
            border-color: #2ecc71;
        }
        
        .card {
            width: 140px;
            height: 190px;
            border-radius: 8px;
            background-color: #fff;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            padding: 10px;
            text-align: center;
            font-weight: bold;
            border-bottom: 1px solid #eee;
        }
        
        .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }
        
        .card-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .card-footer {
            padding: 8px;
            text-align: center;
            font-size: 12px;
            background-color: #f5f5f5;
        }
        
        .card.golden {
            background: linear-gradient(135deg, #ffd700, #daa520);
        }
        
        .card.diamond {
            background: linear-gradient(135deg, #b9f2ff, #7ec0ee);
        }
        
        .sidebar {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .panel {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .panel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        
        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 14px;
            margin-bottom: 10px;
            width: 100%;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            width: auto;
        }
        
        .inventory {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            max-height: 300px;
            overflow-y: auto;
            padding: 5px;
        }
        
        .inventory-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .inventory-item:hover {
            background-color: #f0f0f0;
            transform: scale(1.05);
        }
        
        .quest-panel {
            margin-top: 20px;
        }
        
        .quest {
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 0 5px 5px 0;
        }
        
        .quest-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .quest-progress {
            height: 5px;
            background-color: #eee;
            border-radius: 5px;
            margin: 5px 0;
        }
        
        .quest-progress-bar {
            height: 100%;
            background-color: #2ecc71;
            border-radius: 5px;
            width: 0%;
        }
        
        .quest-reward {
            font-size: 12px;
            color: #27ae60;
            font-weight: bold;
        }
        
        .quest-timer {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #2ecc71;
            color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .notification.show {
            opacity: 1;
        }
        
        .upgrades {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .upgrade {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .upgrade-info {
            flex: 1;
        }
        
        .upgrade-title {
            font-weight: bold;
        }
        
        .upgrade-desc {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .basement {
            margin-top: 20px;
            padding: 15px;
            background-color: #34495e;
            border-radius: 8px;
            color: white;
        }
        
        .basement-title {
            font-size: 18px;
            margin-bottom: 15px;
            border-bottom: 1px solid #2c3e50;
            padding-bottom: 8px;
        }
        
        .mutations {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .mutation {
            flex: 1;
            background-color: #2c3e50;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mutation:hover {
            background-color: #1a252f;
        }
        
        .mutation.active {
            background-color: #16a085;
        }
        
        .event-banner {
            background-color: #e74c3c;
            color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .tooltip {
            position: absolute;
            background-color: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            max-width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>–ö–∞—Ä—Ç–æ—á–Ω–∞—è –ò–≥—Ä–∞</h1>
            <div class="resources">
                <div class="resource">
                    <span>üí∞</span>
                    <span id="money">0</span>¬¢
                </div>
                <div class="resource">
                    <span>üíé</span>
                    <span id="diamonds">0</span>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="game-area">
                <h2>–ò–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ</h2>
                <div class="blocks-container" id="blocks-container"></div>
                
                <div class="actions">
                    <button id="buy-block-btn" class="btn">–ö—É–ø–∏—Ç—å –±–ª–æ–∫ (+1) - <span id="block-price">25</span>¬¢</button>
                    <button id="buy-slot-btn" class="btn">–£–≤–µ–ª–∏—á–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å (+5) - <span id="slot-price">5</span>¬¢</button>
                </div>
                
                <div class="basement">
                    <div class="basement-title">–ü–æ–¥–≤–∞–ª (–ö–≤–µ—Å—Ç—ã)</div>
                    <div id="quest-container"></div>
                </div>
            </div>
            
            <div class="sidebar">
                <div class="panel">
                    <div class="panel-title">–ú–∞–≥–∞–∑–∏–Ω</div>
                    <button id="small-pack-btn" class="btn">–ú–∞–ª—ã–π –Ω–∞–±–æ—Ä (3 –∫–∞—Ä—Ç—ã) - 10¬¢</button>
                    <button id="big-pack-btn" class="btn">–ë–æ–ª—å—à–æ–π –Ω–∞–±–æ—Ä (5 –∫–∞—Ä—Ç) - 25¬¢</button>
                    <button id="ultra-pack-btn" class="btn">–£–ª—å—Ç—Ä–∞ –Ω–∞–±–æ—Ä (8 –∫–∞—Ä—Ç) - 50¬¢</button>
                </div>
                
                <div class="panel">
                    <div class="panel-title">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å (<span id="inventory-count">0</span>/<span id="max-cards">15</span>)</div>
                    <div class="inventory" id="inventory"></div>
                </div>
                
                <div class="panel">
                    <div class="panel-title">–ú—É—Ç–∞—Ü–∏–∏</div>
                    <div class="mutations">
                        <div class="mutation" id="golden-mutation">
                            <div>–ó–æ–ª–æ—Ç–∞—è</div>
                            <div id="golden-count">0</div>
                        </div>
                        <div class="mutation" id="diamond-mutation">
                            <div>–ê–ª–º–∞–∑–Ω–∞—è</div>
                            <div id="diamond-count">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    <div class="tooltip" id="tooltip"></div>
    
    <script>
        // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∏–≥—Ä—ã
        const CARD_TYPES = [
            { name: "–ú–µ–¥—å", value: 0.1, color: "#b87333", rarity: 0 },
            { name: "–°–µ—Ä–µ–±—Ä–æ", value: 0.5, color: "#c0c0c0", rarity: 1 },
            { name: "–ó–æ–ª–æ—Ç–æ", value: 2, color: "#ffd700", rarity: 2 },
            { name: "–ü–ª–∞—Ç–∏–Ω–∞", value: 5, color: "#e5e4e2", rarity: 3 },
            { name: "–ö—Ä–∏—Å—Ç–∞–ª–ª", value: 10, color: "#a7d8de", rarity: 4 },
            { name: "–†—É–±–∏–Ω", value: 25, color: "#e0115f", rarity: 5 },
            { name: "–ê–ª–º–∞–∑", value: 50, color: "#b9f2ff", rarity: 6 }
        ];
        
        const QUEST_TYPES = [
            {
                name: "–ù–æ–≤–∏—á–æ–∫",
                description: "–ü–æ–ª—É—á–∏—Ç–µ 50¬¢ —Å –∫–∞—Ä—Ç",
                target: 50,
                reward: { money: 10, diamonds: 0 },
                rarity: 0
            },
            {
                name: "–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–µ—Ä",
                description: "–°–æ–±–µ—Ä–∏—Ç–µ 10 –∫–∞—Ä—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ",
                target: 10,
                reward: { money: 15, diamonds: 1 },
                rarity: 1
            },
            {
                name: "–ò–Ω–≤–µ—Å—Ç–æ—Ä",
                description: "–ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ 200¬¢ —Å –∫–∞—Ä—Ç",
                target: 200,
                reward: { money: 30, diamonds: 2 },
                rarity: 2
            },
            {
                name: "–ë–æ–≥–∞—á",
                description: "–ü–æ–ª—É—á–∏—Ç–µ 500¬¢ —Å –∫–∞—Ä—Ç",
                target: 500,
                reward: { money: 50, diamonds: 5 },
                rarity: 3
            },
            {
                name: "–ö–∞—Ä—Ç–æ—á–Ω—ã–π –º–∞–≥–Ω–∞—Ç",
                description: "–°–æ–±–µ—Ä–∏—Ç–µ 25 –∫–∞—Ä—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ",
                target: 25,
                reward: { money: 75, diamonds: 8 },
                rarity: 4
            },
            {
                name: "–õ–µ–≥–µ–Ω–¥–∞",
                description: "–ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ 1000¬¢ —Å –∫–∞—Ä—Ç",
                target: 1000,
                reward: { money: 100, diamonds: 15 },
                rarity: 5
            }
        ];
        
        const MUTATIONS = {
            golden: {
                name: "–ó–æ–ª–æ—Ç–∞—è –º—É—Ç–∞—Ü–∏—è",
                description: "–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –¥–æ—Ö–æ–¥ –∫–∞—Ä—Ç –Ω–∞ 50%",
                cost: 10,
                effect: (card) => {
                    card.income *= 1.5;
                    card.type = "golden";
                }
            },
            diamond: {
                name: "–ê–ª–º–∞–∑–Ω–∞—è –º—É—Ç–∞—Ü–∏—è",
                description: "–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –¥–æ—Ö–æ–¥ –∫–∞—Ä—Ç –Ω–∞ 150%",
                cost: 25,
                effect: (card) => {
                    card.income *= 2.5;
                    card.type = "diamond";
                }
            }
        };
        
        const EVENTS = [
            {
                name: "–ó–æ–ª–æ—Ç–∞—è –ª–∏—Ö–æ—Ä–∞–¥–∫–∞",
                description: "–í—Å–µ –∫–∞—Ä—Ç—ã –ø—Ä–∏–Ω–æ—Å—è—Ç –≤ 2 —Ä–∞–∑–∞ –±–æ–ª—å—à–µ –¥–æ—Ö–æ–¥–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç!",
                duration: 300,
                effect: () => {
                    gameState.eventMultiplier = 2;
                },
                endEffect: () => {
                    gameState.eventMultiplier = 1;
                }
            },
            {
                name: "–£–¥–∞—á–∞ –Ω–æ–≤–∏—á–∫–∞",
                description: "–®–∞–Ω—Å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–¥–∫–∏–µ –∫–∞—Ä—Ç—ã —É–≤–µ–ª–∏—á–µ–Ω –Ω–∞ 20% –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç!",
                duration: 300,
                effect: () => {
                    gameState.eventLuck = 0.2;
                },
                endEffect: () => {
                    gameState.eventLuck = 0;
                }
            },
            {
                name: "–ë–æ–Ω—É—Å–Ω—ã–π —á–∞—Å",
                description: "–í—Å–µ –Ω–∞–≥—Ä–∞–¥—ã –∑–∞ –∫–≤–µ—Å—Ç—ã —É–≤–µ–ª–∏—á–µ–Ω—ã –Ω–∞ 50% –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç!",
                duration: 300,
                effect: () => {
                    gameState.questBonus = 1.5;
                },
                endEffect: () => {
                    gameState.questBonus = 1;
                }
            }
        ];

        // –ò–≥—Ä–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        let gameState = {
            money: 15,
            diamonds: 0,
            cards: [],
            placedCards: [],
            blocks: 3,
            maxCards: 15,
            blockPrice: 25,
            slotPrice: 5,
            lastPlayTime: Date.now(),
            smallPacksOpened: 0,
            bigPacksOpened: 0,
            ultraPacksOpened: 0,
            slotsUpgraded: 0,
            blocksUpgraded: 0,
            rareCardsFound: 0,
            mutations: {
                golden: 0,
                diamond: 0
            },
            activeMutations: {},
            currentQuest: null,
            questProgress: 0,
            questCompleted: false,
            questTimer: 120,
            totalEarned: 0,
            totalCardsCollected: 0,
            eventActive: null,
            eventTimer: null,
            eventMultiplier: 1,
            eventLuck: 0,
            questBonus: 1,
            lastQuestUpdate: Date.now()
        };

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const elements = {
            money: document.getElementById('money'),
            diamonds: document.getElementById('diamonds'),
            blocksContainer: document.getElementById('blocks-container'),
            inventory: document.getElementById('inventory'),
            inventoryCount: document.getElementById('inventory-count'),
            maxCards: document.getElementById('max-cards'),
            smallPackBtn: document.getElementById('small-pack-btn'),
            bigPackBtn: document.getElementById('big-pack-btn'),
            ultraPackBtn: document.getElementById('ultra-pack-btn'),
            buyBlockBtn: document.getElementById('buy-block-btn'),
            buySlotBtn: document.getElementById('buy-slot-btn'),
            blockPrice: document.getElementById('block-price'),
            slotPrice: document.getElementById('slot-price'),
            goldenMutation: document.getElementById('golden-mutation'),
            diamondMutation: document.getElementById('diamond-mutation'),
            goldenCount: document.getElementById('golden-count'),
            diamondCount: document.getElementById('diamond-count'),
            questContainer: document.getElementById('quest-container'),
            notification: document.getElementById('notification'),
            tooltip: document.getElementById('tooltip')
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function initGame() {
            loadGame();
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è placedCards
            if (!Array.isArray(gameState.placedCards)) {
                gameState.placedCards = [];
            }
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º null –¥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±–ª–æ–∫–æ–≤
            while (gameState.placedCards.length < gameState.blocks) {
                gameState.placedCards.push(null);
            }
            
            // –£–¥–∞–ª—è–µ–º –ª–∏—à–Ω–∏–µ –∫–∞—Ä—Ç—ã, –µ—Å–ª–∏ –±–ª–æ–∫–æ–≤ —Å—Ç–∞–ª–æ –º–µ–Ω—å—à–µ
            if (gameState.placedCards.length > gameState.blocks) {
                const removedCards = gameState.placedCards.splice(gameState.blocks);
                gameState.cards = gameState.cards.concat(removedCards.filter(card => card !== null));
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–≤–µ—Å—Ç–∞
            if (!gameState.currentQuest && gameState.questTimer <= 0) {
                generateNewQuest();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateUI();
            renderBlocks();
            renderInventory();
            updateQuestUI();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
            setInterval(passiveIncome, 1000);
            setInterval(saveGame, 30000);
            setInterval(updateQuestTimer, 1000);
            setInterval(checkForRandomEvent, 60000);
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            setupEventListeners();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
            showNotification("–ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!");
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            elements.smallPackBtn.addEventListener('click', () => buyCardPack(3, 10));
            elements.bigPackBtn.addEventListener('click', () => buyCardPack(5, 25));
            elements.ultraPackBtn.addEventListener('click', () => buyCardPack(8, 50));
            
            elements.buyBlockBtn.addEventListener('click', buyBlock);
            elements.buySlotBtn.addEventListener('click', buySlot);
            
            elements.goldenMutation.addEventListener('click', () => activateMutation('golden'));
            elements.diamondMutation.addEventListener('click', () => activateMutation('diamond'));
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è tooltip
            document.addEventListener('mousemove', (e) => {
                elements.tooltip.style.left = `${e.pageX + 10}px`;
                elements.tooltip.style.top = `${e.pageY + 10}px`;
            });
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–≥—Ä—ã
        function loadGame() {
            const saved = localStorage.getItem('cardGameSave');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                    gameState.money = parsed.money || 15;
                    gameState.diamonds = parsed.diamonds || 0;
                    gameState.blocks = parsed.blocks || 3;
                    gameState.maxCards = parsed.maxCards || 15;
                    gameState.blockPrice = parsed.blockPrice || 25;
                    gameState.slotPrice = parsed.slotPrice || 5;
                    gameState.smallPacksOpened = parsed.smallPacksOpened || 0;
                    gameState.bigPacksOpened = parsed.bigPacksOpened || 0;
                    gameState.ultraPacksOpened = parsed.ultraPacksOpened || 0;
                    gameState.slotsUpgraded = parsed.slotsUpgraded || 0;
                    gameState.blocksUpgraded = parsed.blocksUpgraded || 0;
                    gameState.rareCardsFound = parsed.rareCardsFound || 0;
                    gameState.totalEarned = parsed.totalEarned || 0;
                    gameState.totalCardsCollected = parsed.totalCardsCollected || 0;
                    gameState.lastPlayTime = parsed.lastPlayTime || Date.now();
                    gameState.lastQuestUpdate = parsed.lastQuestUpdate || Date.now();
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞—Ä—Ç—ã
                    if (parsed.cards && Array.isArray(parsed.cards)) {
                        gameState.cards = parsed.cards;
                    } else {
                        gameState.cards = [];
                    }
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã
                    if (parsed.placedCards && Array.isArray(parsed.placedCards)) {
                        gameState.placedCards = parsed.placedCards;
                    } else {
                        gameState.placedCards = [];
                    }
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º—É—Ç–∞—Ü–∏–∏
                    if (parsed.mutations) {
                        gameState.mutations = parsed.mutations;
                    } else {
                        gameState.mutations = { golden: 0, diamond: 0 };
                    }
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –º—É—Ç–∞—Ü–∏–∏
                    if (parsed.activeMutations) {
                        gameState.activeMutations = parsed.activeMutations;
                    } else {
                        gameState.activeMutations = {};
                    }
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–≤–µ—Å—Ç
                    if (parsed.currentQuest) {
                        gameState.currentQuest = parsed.currentQuest;
                        gameState.questProgress = parsed.questProgress || 0;
                        gameState.questCompleted = parsed.questCompleted || false;
                        gameState.questTimer = parsed.questTimer || 120;
                    }
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏–µ
                    if (parsed.eventActive) {
                        gameState.eventActive = parsed.eventActive;
                        gameState.eventTimer = parsed.eventTimer;
                        startEvent(gameState.eventActive);
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ñ—Ñ–ª–∞–π–Ω –¥–æ—Ö–æ–¥
                    const now = Date.now();
                    const offlineTime = Math.min(now - gameState.lastPlayTime, 86400000); // –ú–∞–∫—Å–∏–º—É–º 24 —á–∞—Å–∞
                    const offlineSeconds = Math.floor(offlineTime / 1000);
                    
                    if (offlineSeconds > 0 && gameState.placedCards.some(card => card !== null)) {
                        let offlineIncome = 0;
                        gameState.placedCards.forEach(card => {
                            if (card) {
                                const income = card.income * offlineSeconds * (gameState.eventMultiplier || 1);
                                offlineIncome += income;
                                card.totalEarned += income;
                                gameState.totalEarned += income;
                            }
                        });
                        
                        if (offlineIncome > 0) {
                            gameState.money += offlineIncome;
                            showNotification(`–í—ã –ø–æ–ª—É—á–∏–ª–∏ ${offlineIncome.toFixed(2)}¬¢ –∑–∞ ${formatTime(offlineSeconds)} –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è!`);
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–≤–µ—Å—Ç–∞
                        updateQuestProgress('earn', offlineIncome);
                    }
                    
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", e);
                    resetGame();
                }
            } else {
                resetGame();
            }
        }

        // –°–±—Ä–æ—Å –∏–≥—Ä—ã
        function resetGame() {
            gameState = {
                money: 15,
                diamonds: 0,
                cards: [],
                placedCards: [],
                blocks: 3,
                maxCards: 15,
                blockPrice: 25,
                slotPrice: 5,
                lastPlayTime: Date.now(),
                smallPacksOpened: 0,
                bigPacksOpened: 0,
                ultraPacksOpened: 0,
                slotsUpgraded: 0,
                blocksUpgraded: 0,
                rareCardsFound: 0,
                mutations: {
                    golden: 0,
                    diamond: 0
                },
                activeMutations: {},
                currentQuest: null,
                questProgress: 0,
                questCompleted: false,
                questTimer: 120,
                totalEarned: 0,
                totalCardsCollected: 0,
                eventActive: null,
                eventTimer: null,
                eventMultiplier: 1,
                eventLuck: 0,
                questBonus: 1,
                lastQuestUpdate: Date.now()
            };
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º placedCards
            for (let i = 0; i < gameState.blocks; i++) {
                gameState.placedCards.push(null);
            }
            
            generateNewQuest();
            saveGame();
        }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–≥—Ä—ã
        function saveGame() {
            gameState.lastPlayTime = Date.now();
            localStorage.setItem('cardGameSave', JSON.stringify(gameState));
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        function updateUI() {
            elements.money.textContent = gameState.money.toFixed(2);
            elements.diamonds.textContent = gameState.diamonds;
            elements.blockPrice.textContent = gameState.blockPrice;
            elements.slotPrice.textContent = gameState.slotPrice;
            elements.maxCards.textContent = gameState.maxCards;
            elements.inventoryCount.textContent = gameState.cards.length;
            elements.goldenCount.textContent = gameState.mutations.golden;
            elements.diamondCount.textContent = gameState.mutations.diamond;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
            elements.smallPackBtn.disabled = gameState.money < 10 || gameState.cards.length >= gameState.maxCards;
            elements.bigPackBtn.disabled = gameState.money < 25 || gameState.cards.length >= gameState.maxCards - 4;
            elements.ultraPackBtn.disabled = gameState.money < 50 || gameState.cards.length >= gameState.maxCards - 7;
            elements.buyBlockBtn.disabled = gameState.money < gameState.blockPrice;
            elements.buySlotBtn.disabled = gameState.money < gameState.slotPrice;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –º—É—Ç–∞—Ü–∏–∏
            elements.goldenMutation.classList.toggle('active', gameState.activeMutations.golden);
            elements.diamondMutation.classList.toggle('active', gameState.activeMutations.diamond);
        }

        // –†–µ–Ω–¥–µ—Ä –±–ª–æ–∫–æ–≤
        function renderBlocks() {
            elements.blocksContainer.innerHTML = '';
            
            for (let i = 0; i < gameState.blocks; i++) {
                const block = document.createElement('div');
                block.className = 'block';
                
                if (gameState.placedCards[i]) {
                    const card = gameState.placedCards[i];
                    const cardElement = createCardElement(card);
                    block.appendChild(cardElement);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–Ω—è—Ç–∏—è –∫–∞—Ä—Ç—ã
                    cardElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeCardFromBlock(i);
                    });
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
                block.addEventListener('click', () => {
                    if (!gameState.placedCards[i]) {
                        openCardSelection(i);
                    }
                });
                
                elements.blocksContainer.appendChild(block);
            }
        }

        // –†–µ–Ω–¥–µ—Ä –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        function renderInventory() {
            elements.inventory.innerHTML = '';
            
            gameState.cards.forEach((card, index) => {
                const cardElement = createCardElement(card);
                cardElement.classList.add('inventory-item');
                cardElement.style.transform = 'scale(0.9)';
                
                // –î–æ–±–∞–≤–ª—è–µ–º tooltip
                cardElement.addEventListener('mouseenter', (e) => {
                    showTooltip(e, `–î–æ—Ö–æ–¥: ${card.income.toFixed(2)}¬¢/—Å–µ–∫\n–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ: ${card.totalEarned.toFixed(2)}¬¢`);
                });
                
                cardElement.addEventListener('mouseleave', hideTooltip);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
                cardElement.addEventListener('click', () => {
                    const emptyBlockIndex = gameState.placedCards.indexOf(null);
                    if (emptyBlockIndex !== -1) {
                        placeCardFromInventory(index, emptyBlockIndex);
                    } else {
                        showNotification("–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∫–∞—Ä—Ç—ã!");
                    }
                });
                
                elements.inventory.appendChild(cardElement);
            });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∫–∞—Ä—Ç—ã
        function createCardElement(card) {
            const cardElement = document.createElement('div');
            cardElement.className = 'card';
            
            if (card.type === 'golden') {
                cardElement.classList.add('golden');
            } else if (card.type === 'diamond') {
                cardElement.classList.add('diamond');
            }
            
            const cardHeader = document.createElement('div');
            cardHeader.className = 'card-header';
            cardHeader.textContent = card.name;
            cardHeader.style.color = card.color;
            
            const cardBody = document.createElement('div');
            cardBody.className = 'card-body';
            
            const cardValue = document.createElement('div');
            cardValue.className = 'card-value';
            cardValue.textContent = card.income.toFixed(2) + '¬¢';
            
            const cardFooter = document.createElement('div');
            cardFooter.className = 'card-footer';
            cardFooter.textContent = `–£—Ä. ${card.level}`;
            
            cardBody.appendChild(cardValue);
            cardElement.appendChild(cardHeader);
            cardElement.appendChild(cardBody);
            cardElement.appendChild(cardFooter);
            
            return cardElement;
        }

        // –ü–æ–∫—É–ø–∫–∞ –Ω–∞–±–æ—Ä–∞ –∫–∞—Ä—Ç
        function buyCardPack(count, price) {
            if (gameState.money < price) {
                showNotification("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!");
                return;
            }
            
            if (gameState.cards.length + count > gameState.maxCards) {
                showNotification("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–µ—Å—Ç–∞ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ!");
                return;
            }
            
            gameState.money -= price;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –Ω–∞–±–æ—Ä–∞
            if (count === 3) {
                gameState.smallPacksOpened++;
            } else if (count === 5) {
                gameState.bigPacksOpened++;
            } else if (count === 8) {
                gameState.ultraPacksOpened++;
            }
            
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—ã
            for (let i = 0; i < count; i++) {
                const card = generateRandomCard();
                gameState.cards.push(card);
                gameState.totalCardsCollected++;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Ä–µ–¥–∫—É—é –∫–∞—Ä—Ç—É
                if (card.rarity >= 4) {
                    gameState.rareCardsFound++;
                    showNotification(`–†–µ–¥–∫–∞—è –∫–∞—Ä—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞: ${card.name}!`, 3000);
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–≤–µ—Å—Ç–∞
            updateQuestProgress('collect', count);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateUI();
            renderInventory();
            saveGame();
            
            showNotification(`–í—ã –∫—É–ø–∏–ª–∏ –Ω–∞–±–æ—Ä –∏–∑ ${count} –∫–∞—Ä—Ç –∑–∞ ${price}¬¢!`);
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–π –∫–∞—Ä—Ç—ã
        function generateRandomCard() {
            // –£—á–∏—Ç—ã–≤–∞–µ–º –±–æ–Ω—É—Å —Å–æ–±—ã—Ç–∏—è
            const luckBonus = gameState.eventLuck || 0;
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—É—é —Ä–µ–¥–∫–æ—Å—Ç—å —Å —É—á–µ—Ç–æ–º –±–æ–Ω—É—Å–∞
            let rarityRoll = Math.random() + luckBonus;
            let rarity;
            
            if (rarityRoll < 0.6) rarity = 0; // 60% (—Å —É—á–µ—Ç–æ–º –±–æ–Ω—É—Å–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ)
            else if (rarityRoll < 0.85) rarity = 1; // 25%
            else if (rarityRoll < 0.95) rarity = 2; // 10%
            else if (rarityRoll < 0.99) rarity = 3; // 4%
            else if (rarityRoll < 0.998) rarity = 4; // 0.8%
            else if (rarityRoll < 0.9998) rarity = 5; // 0.18%
            else rarity = 6; // 0.02%
            
            // –ü–æ–ª—É—á–∞–µ–º —Ç–∏–ø –∫–∞—Ä—Ç—ã –ø–æ —Ä–µ–¥–∫–æ—Å—Ç–∏
            const cardType = CARD_TYPES.find(type => type.rarity === rarity) || CARD_TYPES[0];
            
            // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
            const card = {
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                name: cardType.name,
                value: cardType.value,
                income: cardType.value * 0.1, // –ë–∞–∑–æ–≤—ã–π –¥–æ—Ö–æ–¥
                color: cardType.color,
                rarity: cardType.rarity,
                level: 1,
                totalEarned: 0,
                type: 'normal'
            };
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –º—É—Ç–∞—Ü–∏–∏
            if (gameState.activeMutations.golden) {
                MUTATIONS.golden.effect(card);
            }
            if (gameState.activeMutations.diamond) {
                MUTATIONS.diamond.effect(card);
            }
            
            return card;
        }

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –≤—ã–±–æ—Ä–∞ –∫–∞—Ä—Ç—ã –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
        function openCardSelection(blockIndex) {
            if (gameState.cards.length === 0) {
                showNotification("–í –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ –Ω–µ—Ç –∫–∞—Ä—Ç!");
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–∞—Ä—Ç—ã
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.7)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';
            
            const modalContent = document.createElement('div');
            modalContent.style.backgroundColor = 'white';
            modalContent.style.padding = '20px';
            modalContent.style.borderRadius = '10px';
            modalContent.style.maxWidth = '80%';
            modalContent.style.maxHeight = '80%';
            modalContent.style.overflowY = 'auto';
            
            const title = document.createElement('h3');
            title.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç—É –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è';
            modalContent.appendChild(title);
            
            const cardsContainer = document.createElement('div');
            cardsContainer.style.display = 'grid';
            cardsContainer.style.gridTemplateColumns = 'repeat(auto-fill, minmax(120px, 1fr))';
            cardsContainer.style.gap = '10px';
            cardsContainer.style.marginTop = '15px';
            
            gameState.cards.forEach((card, index) => {
                const cardElement = createCardElement(card);
                cardElement.style.transform = 'scale(0.8)';
                cardElement.style.cursor = 'pointer';
                
                cardElement.addEventListener('click', () => {
                    placeCardFromInventory(index, blockIndex);
                    document.body.removeChild(modal);
                });
                
                cardsContainer.appendChild(cardElement);
            });
            
            modalContent.appendChild(cardsContainer);
            
            const closeButton = document.createElement('button');
            closeButton.textContent = '–ó–∞–∫—Ä—ã—Ç—å';
            closeButton.className = 'btn';
            closeButton.style.marginTop = '15px';
            closeButton.addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            modalContent.appendChild(closeButton);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
        }

        // –†–∞–∑–º–µ—â–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        function placeCardFromInventory(cardIndex, blockIndex) {
            const card = gameState.cards[cardIndex];
            
            // –£–¥–∞–ª—è–µ–º –∫–∞—Ä—Ç—É –∏–∑ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
            gameState.cards.splice(cardIndex, 1);
            
            // –†–∞–∑–º–µ—â–∞–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –±–ª–æ–∫–µ
            gameState.placedCards[blockIndex] = card;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateUI();
            renderBlocks();
            renderInventory();
            saveGame();
        }

        // –°–Ω—è—Ç–∏–µ –∫–∞—Ä—Ç—ã —Å –±–ª–æ–∫–∞
        function removeCardFromBlock(blockIndex) {
            const card = gameState.placedCards[blockIndex];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –º–µ—Å—Ç–æ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ
            if (gameState.cards.length >= gameState.maxCards) {
                showNotification("–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø–æ–ª–æ–Ω! –£–≤–µ–ª–∏—á—å—Ç–µ —Ä–∞–∑–º–µ—Ä –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –∏–ª–∏ –ø—Ä–æ–¥–∞–π—Ç–µ –∫–∞—Ä—Ç—ã.");
                return;
            }
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞—Ä—Ç—É –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
            gameState.cards.push(card);
            gameState.placedCards[blockIndex] = null;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            updateUI();
            renderBlocks();
            renderInventory();
            saveGame();
        }

        // –ü–∞—Å—Å–∏–≤–Ω—ã–π –¥–æ—Ö–æ–¥
        function passiveIncome() {
            let totalIncome = 0;
            
            gameState.placedCards.forEach(card => {
                if (card) {
                    const income = card.income * (gameState.eventMultiplier || 1);
                    gameState.money += income;
                    card.totalEarned += income;
                    gameState.totalEarned += income;
                    totalIncome += income;
                }
            });
            
            if (totalIncome > 0) {
                updateUI();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–≤–µ—Å—Ç–∞
                updateQuestProgress('earn', totalIncome);
            }
        }

        // –ü–æ–∫—É–ø–∫–∞ –±–ª–æ–∫–∞
        function buyBlock() {
            if (gameState.money < gameState.blockPrice) {
                showNotification("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!");
                return;
            }
            
            gameState.money -= gameState.blockPrice;
            gameState.blocks++;
            gameState.blocksUpgraded++;
            gameState.placedCards.push(null);
            gameState.blockPrice = Math.floor(gameState.blockPrice * 1.5);
            
            updateUI();
            renderBlocks();
            saveGame();
            
            showNotification(`–í—ã –∫—É–ø–∏–ª–∏ –Ω–æ–≤—ã–π –±–ª–æ–∫! –¢–µ–ø–µ—Ä—å —É –≤–∞—Å ${gameState.blocks} –±–ª–æ–∫–æ–≤.`);
        }

        // –ü–æ–∫—É–ø–∫–∞ —Å–ª–æ—Ç–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        function buySlot() {
            if (gameState.money < gameState.slotPrice) {
                showNotification("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–µ–Ω–µ–≥!");
                return;
            }
            
            gameState.money -= gameState.slotPrice;
            gameState.maxCards += 5;
            gameState.slotsUpgraded++;
            gameState.slotPrice = Math.floor(gameState.slotPrice * 1.3);
            
            updateUI();
            saveGame();
            
            showNotification(`–í—ã —É–≤–µ–ª–∏—á–∏–ª–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å! –¢–µ–ø–µ—Ä—å –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: ${gameState.maxCards} –∫–∞—Ä—Ç.`);
        }

        // –ê–∫—Ç–∏–≤–∞—Ü–∏—è –º—É—Ç–∞—Ü–∏–∏
        function activateMutation(type) {
            if (gameState.mutations[type] <= 0) {
                showNotification(`–£ –≤–∞—Å –Ω–µ—Ç ${MUTATIONS[type].name} –º—É—Ç–∞—Ü–∏–π!`);
                return;
            }
            
            gameState.activeMutations[type] = !gameState.activeMutations[type];
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –º—É—Ç–∞—Ü–∏—é –∫–æ –≤—Å–µ–º –∫–∞—Ä—Ç–∞–º
            if (gameState.activeMutations[type]) {
                // –î–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç
                gameState.placedCards.forEach(card => {
                    if (card) {
                        MUTATIONS[type].effect(card);
                    }
                });
                
                // –î–ª—è –∫–∞—Ä—Ç –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ
                gameState.cards.forEach(card => {
                    MUTATIONS[type].effect(card);
                });
            } else {
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º—É—Ç–∞—Ü–∏—é –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ä—Ç (—Å–ª–æ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞, —É–ø—Ä–æ—â–µ–Ω–Ω–æ)
                // –í —Ä–µ–∞–ª—å–Ω–æ–π –∏–≥—Ä–µ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
                gameState.placedCards.forEach(card => {
                    if (card) {
                        card.income = card.value * 0.1;
                        card.type = 'normal';
                    }
                });
                
                gameState.cards.forEach(card => {
                    card.income = card.value * 0.1;
                    card.type = 'normal';
                });
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –¥—Ä—É–≥–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –º—É—Ç–∞—Ü–∏–∏
                if (gameState.activeMutations.golden) {
                    gameState.placedCards.forEach(card => {
                        if (card) MUTATIONS.golden.effect(card);
                    });
                    gameState.cards.forEach(card => MUTATIONS.golden.effect(card));
                }
                
                if (gameState.activeMutations.diamond) {
                    gameState.placedCards.forEach(card => {
                        if (card) MUTATIONS.diamond.effect(card);
                    });
                    gameState.cards.forEach(card => MUTATIONS.diamond.effect(card));
                }
            }
            
            updateUI();
            renderBlocks();
            renderInventory();
            saveGame();
            
            showNotification(`${MUTATIONS[type].name} ${gameState.activeMutations[type] ? '–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞' : '–¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞'}!`);
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∫–≤–µ—Å—Ç–∞
        function generateNewQuest() {
            // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –∫–≤–µ—Å—Ç —Å —É—á–µ—Ç–æ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∏–≥—Ä–æ–∫–∞
            let availableQuests = QUEST_TYPES;
            
            // –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –µ—â–µ –Ω–µ –¥–æ—Å—Ç–∏–≥ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞, –Ω–µ –¥–∞–µ–º —Å–ª–æ–∂–Ω—ã–µ –∫–≤–µ—Å—Ç—ã
            if (gameState.totalEarned < 200) {
                availableQuests = QUEST_TYPES.filter(q => q.rarity <= 2);
            } else if (gameState.totalEarned < 500) {
                availableQuests = QUEST_TYPES.filter(q => q.rarity <= 4);
            }
            
            const randomIndex = Math.floor(Math.random() * availableQuests.length);
            gameState.currentQuest = {...availableQuests[randomIndex]};
            gameState.questProgress = 0;
            gameState.questCompleted = false;
            gameState.questTimer = 120; // 2 –º–∏–Ω—É—Ç—ã –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
            gameState.lastQuestUpdate = Date.now();
            
            updateQuestUI();
            saveGame();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞ –∫–≤–µ—Å—Ç–∞
        function updateQuestTimer() {
            if (!gameState.currentQuest || gameState.questCompleted) return;
            
            const now = Date.now();
            const elapsed = Math.floor((now - gameState.lastQuestUpdate) / 1000);
            
            if (elapsed > 0) {
                gameState.questTimer -= elapsed;
                gameState.lastQuestUpdate = now;
                
                if (gameState.questTimer <= 0) {
                    gameState.questTimer = 0;
                    // –ö–≤–µ—Å—Ç –ø—Ä–æ–≤–∞–ª–µ–Ω
                    showNotification(`–ö–≤–µ—Å—Ç "${gameState.currentQuest.name}" –ø—Ä–æ–≤–∞–ª–µ–Ω!`);
                    generateNewQuest();
                }
                
                updateQuestUI();
                saveGame();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫–≤–µ—Å—Ç–∞
        function updateQuestProgress(type, amount) {
            if (!gameState.currentQuest || gameState.questCompleted) return;
            
            let progressNeeded = false;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø –∫–≤–µ—Å—Ç–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            if (type === 'earn' && gameState.currentQuest.description.includes("–ü–æ–ª—É—á–∏—Ç–µ") || 
                gameState.currentQuest.description.includes("–ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ")) {
                gameState.questProgress += amount;
                progressNeeded = true;
            } else if (type === 'collect' && gameState.currentQuest.description.includes("–°–æ–±–µ—Ä–∏—Ç–µ")) {
                gameState.questProgress += amount;
                progressNeeded = true;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–≤–µ—Å—Ç–∞
            if (progressNeeded && gameState.questProgress >= gameState.currentQuest.target) {
                completeQuest();
            } else if (progressNeeded) {
                updateQuestUI();
                saveGame();
            }
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–≤–µ—Å—Ç–∞
        function completeQuest() {
            gameState.questCompleted = true;
            
            // –ù–∞–≥—Ä–∞–¥–∞ —Å —É—á–µ—Ç–æ–º –±–æ–Ω—É—Å–∞ —Å–æ–±—ã—Ç–∏—è
            const rewardMultiplier = gameState.questBonus || 1;
            const moneyReward = Math.floor(gameState.currentQuest.reward.money * rewardMultiplier);
            const diamondsReward = Math.floor(gameState.currentQuest.reward.diamonds * rewardMultiplier);
            
            gameState.money += moneyReward;
            gameState.diamonds += diamondsReward;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º—É—Ç–∞—Ü–∏–∏ –∑–∞ –∞–ª–º–∞–∑—ã
            if (diamondsReward > 0) {
                gameState.mutations.golden += Math.floor(diamondsReward / 2);
                gameState.mutations.diamond += Math.floor(diamondsReward / 5);
            }
            
            showNotification(
                `–ö–≤–µ—Å—Ç "${gameState.currentQuest.name}" –≤—ã–ø–æ–ª–Ω–µ–Ω! ` +
                `–ù–∞–≥—Ä–∞–¥–∞: ${moneyReward}¬¢ –∏ ${diamondsReward}üíé`
            );
            
            updateUI();
            updateQuestUI();
            saveGame();
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –∫–≤–µ—Å—Ç —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(generateNewQuest, 5000);
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∫–≤–µ—Å—Ç–∞
        function updateQuestUI() {
            elements.questContainer.innerHTML = '';
            
            if (!gameState.currentQuest) {
                generateNewQuest();
                return;
            }
            
            const questElement = document.createElement('div');
            questElement.className = 'quest';
            
            const title = document.createElement('div');
            title.className = 'quest-title';
            title.textContent = gameState.currentQuest.name;
            
            const desc = document.createElement('div');
            desc.className = 'quest-desc';
            desc.textContent = gameState.currentQuest.description;
            
            const progressContainer = document.createElement('div');
            progressContainer.className = 'quest-progress';
            
            const progressBar = document.createElement('div');
            progressBar.className = 'quest-progress-bar';
            
            const progressText = document.createElement('div');
            progressText.style.fontSize = '12px';
            progressText.style.marginTop = '5px';
            
            const reward = document.createElement('div');
            reward.className = 'quest-reward';
            
            const timer = document.createElement('div');
            timer.className = 'quest-timer';
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            const progressPercent = Math.min((gameState.questProgress / gameState.currentQuest.target) * 100, 100);
            progressBar.style.width = `${progressPercent}%`;
            
            progressText.textContent = `${Math.min(gameState.questProgress, gameState.currentQuest.target)}/${gameState.currentQuest.target}`;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–≥—Ä–∞–¥—É
            const rewardMultiplier = gameState.questBonus || 1;
            const moneyReward = Math.floor(gameState.currentQuest.reward.money * rewardMultiplier);
            const diamondsReward = Math.floor(gameState.currentQuest.reward.diamonds * rewardMultiplier);
            
            reward.textContent = `–ù–∞–≥—Ä–∞–¥–∞: ${moneyReward}¬¢ + ${diamondsReward}üíé`;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∞–π–º–µ—Ä
            const minutes = Math.floor(gameState.questTimer / 60);
            const seconds = gameState.questTimer % 60;
            timer.textContent = `–û—Å—Ç–∞–ª–æ—Å—å: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            
            // –ï—Å–ª–∏ –∫–≤–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (gameState.questCompleted) {
                const completed = document.createElement('div');
                completed.style.color = '#2ecc71';
                completed.style.fontWeight = 'bold';
                completed.textContent = '–ö–≤–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω! –û–∂–∏–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∫–≤–µ—Å—Ç...';
                questElement.appendChild(completed);
            }
            
            progressContainer.appendChild(progressBar);
            questElement.appendChild(title);
            questElement.appendChild(desc);
            questElement.appendChild(progressContainer);
            questElement.appendChild(progressText);
            questElement.appendChild(reward);
            questElement.appendChild(timer);
            
            elements.questContainer.appendChild(questElement);
        }

        // –°–ª—É—á–∞–π–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
        function checkForRandomEvent() {
            if (gameState.eventActive) return;
            
            // 10% —à–∞–Ω—Å –Ω–∞ —Å–æ–±—ã—Ç–∏–µ
            if (Math.random() < 0.1) {
                const randomEvent = EVENTS[Math.floor(Math.random() * EVENTS.length)];
                startEvent(randomEvent);
            }
        }

        // –ù–∞—á–∞–ª–æ —Å–æ–±—ã—Ç–∏—è
        function startEvent(event) {
            gameState.eventActive = event;
            gameState.eventTimer = event.duration;
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç —Å–æ–±—ã—Ç–∏—è
            event.effect();
            
            // –°–æ–∑–¥–∞–µ–º –±–∞–Ω–Ω–µ—Ä —Å–æ–±—ã—Ç–∏—è
            const eventBanner = document.createElement('div');
            eventBanner.className = 'event-banner';
            eventBanner.textContent = `${event.name}: ${event.description}`;
            eventBanner.id = 'event-banner';
            
            // –í—Å—Ç–∞–≤–ª—è–µ–º –±–∞–Ω–Ω–µ—Ä –ø–µ—Ä–µ–¥ –∏–≥—Ä–æ–≤–æ–π –æ–±–ª–∞—Å—Ç—å—é
            const gameArea = document.querySelector('.game-area');
            gameArea.insertBefore(eventBanner, gameArea.firstChild);
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä —Å–æ–±—ã—Ç–∏—è
            gameState.eventIntervalId = setInterval(() => {
                gameState.eventTimer--;
                
                if (gameState.eventTimer <= 0) {
                    endCurrentEvent();
                }
            }, 1000);
            
            showNotification(`–ù–∞—á–∞–ª–æ—Å—å —Å–æ–±—ã—Ç–∏–µ: ${event.name}!`);
            saveGame();
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–±—ã—Ç–∏—è
        function endCurrentEvent() {
            if (!gameState.eventActive) return;
            
            // –£–¥–∞–ª—è–µ–º –±–∞–Ω–Ω–µ—Ä —Å–æ–±—ã—Ç–∏—è
            const banner = document.getElementById('event-banner');
            if (banner) banner.remove();
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –∑–∞–≤–µ—Ä—à–∞—é—â–∏–π —ç—Ñ—Ñ–µ–∫—Ç
            gameState.eventActive.endEffect();
            
            // –û—á–∏—â–∞–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª
            if (gameState.eventIntervalId) {
                clearInterval(gameState.eventIntervalId);
            }
            
            showNotification(`–°–æ–±—ã—Ç–∏–µ "${gameState.eventActive.name}" –∑–∞–≤–µ—Ä—à–µ–Ω–æ!`);
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
            gameState.eventActive = null;
            gameState.eventTimer = null;
            gameState.eventIntervalId = null;
            
            saveGame();
        }

        // –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(message, duration = 2000) {
            const notification = elements.notification;
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, duration);
        }

        // –ü–æ–∫–∞–∑ –ø–æ–¥—Å–∫–∞–∑–∫–∏
        function showTooltip(event, text) {
            elements.tooltip.textContent = text;
            elements.tooltip.style.opacity = '1';
        }

        // –°–∫—Ä—ã—Ç–∏–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏
        function hideTooltip() {
            elements.tooltip.style.opacity = '0';
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            let result = '';
            if (hours > 0) result += `${hours}—á `;
            if (minutes > 0) result += `${minutes}–º `;
            result += `${secs}—Å`;
            
            return result.trim();
        }

        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = initGame;
    </script>
</body>
</html>
