<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карточная Игра</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 10px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .game-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            background-color: #fff;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 16px;
        }
        
        .blocks {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .block {
            width: 100px;
            height: 100px;
            background-color: #ddd;
            border-radius: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .card {
            width: 90%;
            height: 90%;
            background-color: white;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 14px;
        }
        
        .card.common {
            border: 2px solid #ccc;
            color: #333;
        }
        
        .card.rare {
            border: 2px solid #4da6ff;
            background-color: #e6f2ff;
            color: #003366;
        }
        
        .card.epic {
            border: 2px solid #b366ff;
            background-color: #f0e6ff;
            color: #4d0066;
        }
        
        .card.legendary {
            border: 2px solid #ff9900;
            background-color: #fff2cc;
            color: #663300;
        }

        .card.mythic {
            border: 2px solid #ff9900;
            background-color: red;
            color: #763300;
        }
        
        .card.divine {
            background: linear-gradient(45deg, #ff0000, #ff9900, #33cc33, #0099ff, #9933ff);
            background-size: 400% 400%;
            animation: rainbow 5s ease infinite;
            border: 2px solid gold;
            color: white;
            text-shadow: 0 0 3px black;
        }
        
        .card.secret {
            border: 2px solid #ff9900;
            background-color: black;
            color: white;
        }
        
        .card.golden {
            background: linear-gradient(45deg, #ffd700, #daa520, #ffd700);
            background-size: 200% 200%;
            animation: shine 2s ease infinite;
            border: 2px solid #ffd700;
            color: #333;
        }
        
        .card.wet {
            background-color: #add8e6;
            border: 2px solid #1e90ff;
            color: #00008b;
        }
        
        .card.icy {
            background-color: #e6f7ff;
            border: 2px solid #00bfff;
            color: #003366;
        }
        
        .card.electric {
            background-color: #fffacd;
            border: 2px solid #ffd700;
            color: #ff4500;
            animation: electric 0.5s infinite alternate;
        }
        
        @keyframes rainbow {
            0% {background-position: 0% 50%}
            50% {background-position: 100% 50%}
            100% {background-position: 0% 50%}
        }
        
        @keyframes shine {
            0% {background-position: 0% 50%}
            100% {background-position: 100% 50%}
        }
        
        @keyframes electric {
            from {box-shadow: 0 0 5px #ffd700;}
            to {box-shadow: 0 0 20px #ffd700, 0 0 30px #ff4500;}
        }
        
        .pack-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            cursor: pointer;
            flex-grow: 1;
            font-size: 14px;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .inventory {
            background-color: #fff;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            max-height: 200px;
            overflow-y: auto;
        }
        
        .inventory-title {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 16px;
        }
        
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 5px;
        }
        
        .inventory-card {
            padding: 5px;
            border-radius: 3px;
            font-size: 12px;
            text-align: center;
            cursor: pointer;
            word-break: break-word;
            position: relative;
            transition: all 0.2s;
            user-select: none;
        }
        
        .inventory-card.selected {
            border: 2px solid green;
        }
        
        .inventory-card.selling {
            transform: scale(0.95);
            opacity: 0.8;
            border: 2px dashed red;
        }
        
        .hold-timer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0%;
            height: 3px;
            background-color: #ff5722;
            transition: width 1s linear;
        }
        
        .upgrades {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .pack-opening {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
        }
        
        .pack-card {
            width: 70%;
            max-width: 300px;
            height: 200px;
            background-color: white;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            transform: scale(0);
            animation: cardReveal 0.5s forwards;
            color: #333;
        }
        
        @keyframes cardReveal {
            to { transform: scale(1); }
        }
        
        .pack-info {
            margin-bottom: 20px;
            text-align: center;
            font-size: 18px;
        }
        
        .continue-btn {
            background-color: #4CAF50;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .placed-card {
            position: absolute;
            width: 90%;
            height: 90%;
            cursor: pointer;
        }
        
        .shop-toggle {
            margin-top: 10px;
            background-color: #2196F3;
        }
        
        .shop-container {
            display: none;
            background-color: #fff;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 10px;
        }
        
        .diamond-shop-toggle {
            margin-top: 10px;
            background-color: #FF9800;
        }
        
        .diamond-shop-container {
            display: none;
            background-color: #fff;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 10px;
        }
        
        .quest-container {
            background-color: #fff;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 10px;
        }
        
        .quest-button {
            background-color: #9C27B0;
            margin-top: 10px;
        }
        
        .event-notification {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 200;
            animation: fadeInOut 3s forwards;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; top: -50px; }
            10% { opacity: 1; top: 10px; }
            90% { opacity: 1; top: 10px; }
            100% { opacity: 0; top: -50px; }
        }
        
        .mutation-icon {
            position: absolute;
            top: 2px;
            right: 2px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-weight: bold;
        }
        
        .golden-mutation {
            background-color: gold;
            color: black;
        }
        
        .diamond-mutation {
            background-color: #00bfff;
            color: white;
        }
        
        .wet-mutation {
            background-color: #1e90ff;
            color: white;
        }
        
        .icy-mutation {
            background-color: #87ceeb;
            color: white;
        }
        
        .electric-mutation {
            background-color: #ffd700;
            color: #ff4500;
        }
        
        footer {
            margin-top: 20px;
            padding: 10px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            font-size: 12px;
            text-align: center;
        }
        
        .weather-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            opacity: 0.3;
        }
        
        .rain-effect {
            background: linear-gradient(transparent, rgba(0, 0, 255, 0.1));
            animation: rain 0.5s linear infinite;
        }
        
        .snow-effect {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2 2"><circle cx="1" cy="1" r="1" fill="white"/></svg>');
            animation: snow 5s linear infinite;
        }
        
        .thunder-effect {
            animation: thunder 5s linear infinite;
        }
        
        @keyframes rain {
            0% { background-position: 0 0; }
            100% { background-position: 0 20px; }
        }
        
        @keyframes snow {
            0% { background-position: 0 0; }
            100% { background-position: 0 100%; }
        }
        
        @keyframes thunder {
            0%, 100% { background-color: transparent; }
            1% { background-color: rgba(255, 255, 255, 0.7); }
            2% { background-color: transparent; }
            3% { background-color: rgba(255, 255, 255, 0.5); }
            4% { background-color: transparent; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="stats">
            <div>Монеты: <span id="money">15</span>¢</div>
            <div>Алмазы: <span id="diamonds">0</span>♦</div>
            <div>Карты: <span id="total-cards">0</span>/<span id="max-cards">15</span></div>
        </div>
        
        <div class="blocks" id="blocks">
            <!-- Блоки будут добавлены динамически -->
        </div>
        
        <button class="shop-toggle" id="shop-toggle" onclick="toggleShop()">Показать магазин пачек</button>
        
        <div class="shop-container" id="shop-container">
            <div class="pack-buttons">
                <button id="small-pack" onclick="buyPack('small')">Маленькая пачка (5¢)</button>
                <button id="big-pack" onclick="buyPack('big')">Большая пачка (50¢)</button>
                <button id="premium-pack" onclick="buyPack('premium')">Премиум пачка (500¢)</button>
                <button id="ultra-pack" onclick="buyPack('ultra')">Ультра пачка (50000¢)</button>
                <button id="omega-pack" onclick="buyPack('omega')">ОМЕГА пачка (4000000¢)</button>
                <button id="ruby-pack" onclick="buyPack('ruby')">Рубиновая пачка (45000000¢)</button>
                <button id="ppp-pack" onclick="buyPack('ppp')">СЕКРЕТНАЯ пачка (1000000000¢)</button>
            </div>
        </div>
        
        <button class="diamond-shop-toggle" id="diamond-shop-toggle" onclick="toggleDiamondShop()">Показать магазин алмазов</button>
        
        <div class="diamond-shop-container" id="diamond-shop-container">
            <div class="pack-buttons">
                <button onclick="buyMutation('golden')">Золотая мутация (10♦)</button>
                <button onclick="buyMutation('diamond')">Алмазная мутация (35♦)</button>
                <button onclick="buyUpgrade('slots')">+2 слота (5♦)</button>
                <button onclick="buyUpgrade('blocks')">+2 блока (10♦)</button>
            </div>
        </div>
        
        <div class="upgrades">
            <button onclick="buyBlock()">+1 блок (<span id="block-price">25</span>¢)</button>
            <button onclick="buyCardSlot()">+1 слотов (<span id="slot-price">5</span>¢)</button>
        </div>
        
        <div class="quest-container">
            <div class="inventory-title">
                <span>Квесты</span>
                <span id="quest-timer">До нового квеста: 2:00</span>
            </div>
            <div id="current-quest">Нет активного квеста</div>
            <button class="quest-button" id="get-quest-btn" onclick="handleQuestButton()">Взять квест у Джона</button>
        </div>
        
        <div class="inventory">
            <div class="inventory-title">
                <span>Инвентарь</span>
                <span id="selected-card-name"></span>
            </div>
            <div class="cards-grid" id="inventory">
                <!-- Карты будут добавлены динамически -->
            </div>
        </div>
    </div>
    
    <div class="pack-opening" id="pack-opening" style="display: none;">
        <div class="pack-info" id="pack-info">Открываете маленькую пачку (осталось: 4 карт)</div>
        <div class="pack-card" id="pack-card">
            <!-- Карта будет добавлена динамически -->
        </div>
        <div class="continue-btn" onclick="continueOpening()">Продолжить</div>
    </div>
    
    <div id="weather-effect" class="weather-effect" style="display: none;"></div>
    
    <footer>
        <div class="quest-container">
            <div class="inventory-title">
                <span>Квесты</span>
                <span id="quest-timer">До нового квеста: 2:00</span>
            </div>
            <div id="current-quest">Нет активного квеста</div>
            <button class="quest-button" id="get-quest-btn" onclick="handleQuestButton()">Взять квест у Джона</button>
        </div>
        <p>ОБНОВЛЕНИЕ КАЖДАЯ ПЯТНИЦА:</p>
        <p>18:00, новая версия: 1.1</p>
        <p>ОБНОВЛЕНИЕ ИНФО: хэй!хочешь награды? тебе нужно сделать...</p>
    </footer>
    
    <script>
        // Игровые данные
        let gameState = {
            money: 15,
            diamonds: 0,
            cards: [],
            placedCards: [],
            blocks: 3,
            maxCards: 15,
            blockPrice: 25,
            slotPrice: 5,
            lastPlayTime: Date.now(),
            smallPacksOpened: 0,
            bigPacksOpened: 0,
            ultraPacksOpened: 0,
            slotsUpgraded: 0,
            blocksUpgraded: 0,
            rareCardsFound: 0,
            mutations: {
                golden: 0,
                diamond: 0
            },
            activeMutations: {},
            currentQuest: null,
            questCompleted: false,
            questTimer: 120,
            eventActive: null,
            eventTimer: null,
            eventIntervalId: null
        };
        
        let selectedCard = null;
        let currentPack = null;
        let cardsToOpen = 0;
        let cardsOpened = 0;
        let holdTimers = {};
        let tapStartTime = 0;
        let isSelling = false;
        let sellingCardIndex = null;
        let isShopOpen = false;
        let isDiamondShopOpen = false;
        let selectedMutation = null;
        let mutationApplying = false;

        // Цены продажи карт
        const sellPrices = {
            common: 1,
            rare: 3,
            epic: 10,
            legendary: 40,
            mythic: 200,
            divine: 40000,
            secret: 100000
        };
        
        // Карточные пачки
        const packs = {
            small: {
                price: 5,
                size: { min: 4, max: 6 },
                cards: [
                    { name: "Blockman Go!", chance: 50, rarity: "common", income: 0.01 },
                    { name: "Soul Knight", chance: 35, rarity: "common", income: 0.03 },
                    { name: "Baldi's Basic Classics", chance: 10.5, rarity: "rare", income: 0.07 },
                    { name: "Roblox", chance: 4, rarity: "rare", income: 0.1 },
                    { name: "Cookie Clicker", chance: 0.5, rarity: "epic", income: 0.8 }
                ]
            },
            big: {
                price: 50,
                size: { min: 4, max: 6 },
                cards: [
                    { name: "Baldi's Basic Classics", chance: 40, rarity: "rare", income: 0.07 },
                    { name: "Roblox", chance: 30, rarity: "rare", income: 0.1 },
                    { name: "Dead Cells", chance: 20, rarity: "rare", income: 0.3 },
                    { name: "Cookie Clicker", chance: 9, rarity: "epic", income: 0.8 },
                    { name: "Bandi", chance: 1, rarity: "epic", income: 1.2 }
                ]
            },
            premium: {
                price: 500,
                size: { min: 4, max: 6 },
                cards: [
                    { name: "Bandi", chance: 50, rarity: "epic", income: 1.2 },
                    { name: "Terraria", chance: 30, rarity: "epic", income: 2 },
                    { name: "FL Studio", chance: 17, rarity: "epic", income: 2.5 },
                    { name: "ULTRAKILL", chance: 2.55, rarity: "legendary", income: 3.25 },
                    { name: "GitHub", chance: 0.5, rarity: "legendary", income: 5 },
                    { name: "MINECRAFT", chance: 0.05, rarity: "divine", income: 100 }
                ]
            },
            ultra: {
                price: 50000,
                size: { min: 5, max: 7 },
                cards: [
                    { name: "ULTRAKILL", chance: 40, rarity: "legendary", income: 3.25 },
                    { name: "Nothing", chance: 20, rarity: "legendary", income: 3.75 },
                    { name: "Ball", chance: 15, rarity: "legendary", income: 4.1 },
                    { name: "GitHub", chance: 10, rarity: "legendary", income: 5 },
                    { name: "GeometryDash", chance: 7, rarity: "legendary", income: 7 },
                    { name: "HollowKnight", chance: 6, rarity: "mythic", income: 15 },
                    { name: "Genshin", chance: 1.5, rarity: "mythic", income: 20 },
                    { name: "MINECRAFT", chance: 0.5, rarity: "divine", income: 100 }
                ]
            },
            omega: {
                price: 4000000,
                size: { min: 2, max: 5 },
                cards: [
                    { name: "GeometryDash", chance: 70, rarity: "legendary", income: 7 },
                    { name: "Genshin", chance: 25, rarity: "mythic", income: 20 },
                    { name: "MINECRAFT", chance: 4.4, rarity: "divine", income: 100 },
                    { name: "FNAF", chance: 0.6, rarity: "divine", income: 300 }
                ]
            },
            ruby: {
                price: 45000000,
                size: { min: 4, max: 7 },
                cards: [
                    { name: "stickman War", chance: 60, rarity: "mythic", income: 17.5 },
                    { name: "Genshin", chance: 35, rarity: "mythic", income: 20 },
                    { name: "BreawlStars", chance: 4.1, rarity: "mythic", income: 33 },
                    { name: "MySingingMonsters", chance: 0.9, rarity: "divine", income: 275 },
                ]
            },
            ppp: {
                price: 1000000000,
                size: { min: 1, max: 10 },
                cards: [
                    { name: "MINECRAFT", chance: 50, rarity: "divine", income: 100 },
                    { name: "PACKMAN", chance: 35, rarity: "divine", income: 200 },
                    { name: "???", chance: 10, rarity: "secret", income: 1000 },
                    { name: "UNDERTAL", chance: 4.98, rarity: "secret", income: 2000 },
                    { name: "AI", chance: 0.1, rarity: "secret", income: 10000 },
                    { name: "GOD", chance: 0.01, rarity: "secret", income: 100000 }
                ]
            }
        };
        
        // Квесты
        const quests = [
            {
                id: 1,
                name: "Открыть 5 маленьких пачек",
                description: "Откройте 5 маленьких пачек карт",
                condition: (state) => state.smallPacksOpened >= 5,
                progress: (state) => `Прогресс: ${state.smallPacksOpened}/5`,
                reward: { diamonds: 5 }
            },
            {
                id: 2,
                name: "Открыть 3 больших пачки",
                description: "Откройте 3 больших пачки карт",
                condition: (state) => state.bigPacksOpened >= 3,
                progress: (state) => `Прогресс: ${state.bigPacksOpened}/3`,
                reward: { diamonds: 6 }
            },
            {
                id: 3,
                name: "Открыть 2 ультра пачки",
                description: "Откройте 2 ультра пачки карт",
                condition: (state) => state.ultraPacksOpened >= 2,
                progress: (state) => `Прогресс: ${state.ultraPacksOpened}/2`,
                reward: { diamonds: 10 }
            },
            {
                id: 4,
                name: "Прокачать 5 слотов",
                description: "Увеличьте количество слотов 5 раз",
                condition: (state) => state.slotsUpgraded >= 5,
                progress: (state) => `Прогресс: ${state.slotsUpgraded}/5`,
                reward: { diamonds: 7 }
            },
            {
                id: 5,
                name: "Добавить 3 блока",
                description: "Увеличьте количество блоков 3 раза",
                condition: (state) => state.blocksUpgraded >= 3,
                progress: (state) => `Прогресс: ${state.blocksUpgraded}/3`,
                reward: { diamonds: 10 }
            },
            {
                id: 6,
                name: "Найти редкую карту",
                description: "Выбить карту с шансом менее 1%",
                condition: (state) => state.rareCardsFound >= 1,
                progress: (state) => `Прогресс: ${state.rareCardsFound}/1`,
                reward: { diamonds: 15 }
            }
        ];
        
        // События
        const events = [
            {
                id: 'nothing',
                name: "Ничего не происходит",
                chance: 50,
                duration: 60,
                effect: () => {},
                endEffect: () => {},
                effectClass: '',
                color: '#333'
            },
            {
                id: 'rain',
                name: "Дождь",
                chance: 30,
                duration: 60,
                interval: 20,
                effect: (card) => {
                    if (!card.originalIncome) card.originalIncome = card.income;
                    card.income = card.originalIncome * 2;
                    card.mutation = 'wet';
                    card.tempMutation = 'rain';
                },
                endEffect: (card) => {
                    if (card.tempMutation === 'rain') {
                        card.income = card.originalIncome;
                        delete card.originalIncome;
                        delete card.mutation;
                        delete card.tempMutation;
                    }
                },
                effectClass: 'rain-effect',
                color: '#1e90ff'
            },
            {
                id: 'snowstorm',
                name: "Метель",
                chance: 15,
                duration: 60,
                interval: 15,
                effect: (card) => {
                    if (!card.originalIncome) card.originalIncome = card.income;
                    card.income = card.originalIncome * 3;
                    card.mutation = 'icy';
                    card.tempMutation = 'snowstorm';
                },
                endEffect: (card) => {
                    if (card.tempMutation === 'snowstorm') {
                        card.income = card.originalIncome;
                        delete card.originalIncome;
                        delete card.mutation;
                        delete card.tempMutation;
                    }
                },
                effectClass: 'snow-effect',
                color: '#87ceeb'
            },
            {
                id: 'thunderstorm',
                name: "Гроза",
                chance: 5,
                duration: 60,
                interval: 10,
                effect: (card) => {
                    if (!card.originalIncome) card.originalIncome = card.income;
                    card.income = card.originalIncome * 5;
                    card.mutation = 'electric';
                    card.tempMutation = 'thunderstorm';
                },
                endEffect: (card) => {
                    if (card.tempMutation === 'thunderstorm') {
                        card.income = card.originalIncome;
                        delete card.originalIncome;
                        delete card.mutation;
                        delete card.tempMutation;
                    }
                },
                effectClass: 'thunder-effect',
                color: '#ffd700'
            }
        ];

        // Инициализация игры
        function initGame() {
            loadGame();
            updateUI();
            renderBlocks();
            renderInventory();
            
            setInterval(passiveIncome, 1000);
            setInterval(saveGame, 30000);
            setInterval(updateQuestTimer, 1000);
            setInterval(checkForRandomEvent, 60000);
            
            window.addEventListener('beforeunload', saveGame);
        }
        
        // Сохранение игры
        function saveGame() {
            gameState.lastPlayTime = Date.now();
            localStorage.setItem('cardGameSave', JSON.stringify(gameState));
        }
        
        // Загрузка игры
        function loadGame() {
            const saved = localStorage.getItem('cardGameSave');
            if (saved) {
                const parsed = JSON.parse(saved);
                
                const now = Date.now();
                const offlineTime = now - parsed.lastPlayTime;
                const offlineSeconds = Math.floor(offlineTime / 1000);
                
                if (offlineSeconds > 0 && parsed.placedCards.length > 0) {
                    let offlineIncome = 0;
                    parsed.placedCards.forEach(card => {
                        if (card) offlineIncome += card.income * offlineSeconds;
                    });
                    
                    if (offlineIncome > 0) {
                        parsed.money += offlineIncome;
                        alert(`Вы получили ${offlineIncome.toFixed(2)}¢ за ${formatTime(offlineSeconds)} отсутствия!`);
                    }
                }
                
                gameState = parsed;
                
                if (gameState.eventActive) {
                    endCurrentEvent();
                }
            }
        }
        
        // Форматирование времени
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return [
                hours > 0 ? `${hours}ч` : '',
                minutes > 0 ? `${minutes}м` : '',
                `${secs}с`
            ].filter(Boolean).join(' ');
        }
        
        // Обновление интерфейса
        function updateUI() {
            document.getElementById('money').textContent = gameState.money.toFixed(2);
            document.getElementById('diamonds').textContent = gameState.diamonds;
            document.getElementById('total-cards').textContent = gameState.cards.length;
            document.getElementById('max-cards').textContent = gameState.maxCards;
            document.getElementById('block-price').textContent = gameState.blockPrice;
            document.getElementById('slot-price').textContent = gameState.slotPrice;
            
            document.getElementById('small-pack').disabled = gameState.money < packs.small.price || gameState.cards.length >= gameState.maxCards;
            document.getElementById('big-pack').disabled = gameState.money < packs.big.price || gameState.cards.length >= gameState.maxCards;
            document.getElementById('premium-pack').disabled = gameState.money < packs.premium.price || gameState.cards.length >= gameState.maxCards;
            document.getElementById('ultra-pack').disabled = gameState.money < packs.ultra.price || gameState.cards.length >= gameState.maxCards;
            document.getElementById('omega-pack').disabled = gameState.money < packs.omega.price || gameState.cards.length >= gameState.maxCards;
            document.getElementById('ruby-pack').disabled = gameState.money < packs.ruby.price || gameState.cards.length >= gameState.maxCards;
            document.getElementById('ppp-pack').disabled = gameState.money < packs.ppp.price || gameState.cards.length >= gameState.maxCards;
            
            updateQuestUI();
        }
        
        // Переключение видимости магазина
        function toggleShop() {
            isShopOpen = !isShopOpen;
            const shopContainer = document.getElementById('shop-container');
            const shopToggle = document.getElementById('shop-toggle');
            
            if (isShopOpen) {
                shopContainer.style.display = 'block';
                shopToggle.textContent = 'Скрыть магазин пачек';
            } else {
                shopContainer.style.display = 'none';
                shopToggle.textContent = 'Показать магазин пачек';
            }
        }
        
        // Переключение видимости магазина алмазов
        function toggleDiamondShop() {
            isDiamondShopOpen = !isDiamondShopOpen;
            const diamondShopContainer = document.getElementById('diamond-shop-container');
            const diamondShopToggle = document.getElementById('diamond-shop-toggle');
            
            if (isDiamondShopOpen) {
                diamondShopContainer.style.display = 'block';
                diamondShopToggle.textContent = 'Скрыть магазин алмазов';
            } else {
                diamondShopContainer.style.display = 'none';
                diamondShopToggle.textContent = 'Показать магазин алмазов';
            }
        }
        
        // Рендер блоков
        function renderBlocks() {
            const blocksContainer = document.getElementById('blocks');
            blocksContainer.innerHTML = '';
            
            while (gameState.placedCards.length < gameState.blocks) {
                gameState.placedCards.push(null);
            }
            
            for (let i = 0; i < gameState.blocks; i++) {
                const block = document.createElement('div');
                block.className = 'block';
                block.textContent = i + 1;
                
                if (mutationApplying) {
                    block.onclick = () => applyMutation(i);
                } else if (gameState.placedCards[i]) {
                    block.onclick = (e) => {
                        if (e.target.classList.contains('placed-card')) return;
                        removeCard(i);
                    };
                } else {
                    block.onclick = () => placeCard(i);
                }
                
                if (gameState.placedCards[i]) {
                    const card = gameState.placedCards[i];
                    const cardElement = document.createElement('div');
                    
                    let cardClasses = `placed-card card ${card.rarity}`;
                    if (card.mutation === 'golden') cardClasses += ' golden';
                    else if (card.mutation === 'diamond') cardClasses += ' diamond';
                    else if (card.mutation === 'wet') cardClasses += ' wet';
                    else if (card.mutation === 'icy') cardClasses += ' icy';
                    else if (card.mutation === 'electric') cardClasses += ' electric';
                    
                    cardElement.className = cardClasses;
                    
                    if (!mutationApplying) {
                        cardElement.onclick = (e) => {
                            e.stopPropagation();
                            removeCard(i);
                        };
                    }
                    
                    const nameElement = document.createElement('div');
                    nameElement.textContent = card.name;
                    nameElement.style.fontWeight = 'bold';
                    nameElement.style.fontSize = '12px';
                    
                    const incomeElement = document.createElement('div');
                    incomeElement.textContent = `+${card.income.toFixed(2)}¢/сек`;
                    incomeElement.style.fontSize = '10px';
                    
                    if (card.mutation) {
                        const mutationIcon = document.createElement('div');
                        mutationIcon.className = 'mutation-icon';
                        
                        switch(card.mutation) {
                            case 'golden':
                                mutationIcon.className += ' golden-mutation';
                                mutationIcon.textContent = 'G';
                                break;
                            case 'diamond':
                                mutationIcon.className += ' diamond-mutation';
                                mutationIcon.textContent = 'D';
                                break;
                            case 'wet':
                                mutationIcon.className += ' wet-mutation';
                                mutationIcon.textContent = 'W';
                                break;
                            case 'icy':
                                mutationIcon.className += ' icy-mutation';
                                mutationIcon.textContent = 'I';
                                break;
                            case 'electric':
                                mutationIcon.className += ' electric-mutation';
                                mutationIcon.textContent = 'E';
                                break;
                        }
                        
                        cardElement.appendChild(mutationIcon);
                    }
                    
                    cardElement.appendChild(nameElement);
                    cardElement.appendChild(incomeElement);
                    block.appendChild(cardElement);
                }
                
                blocksContainer.appendChild(block);
            }
        }
        
        // Рендер инвентаря
        function renderInventory() {
            const inventory = document.getElementById('inventory');
            inventory.innerHTML = '';
            
            gameState.cards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = `inventory-card card ${card.rarity}`;
                cardElement.textContent = card.name;
                cardElement.dataset.index = index;
                
                if (selectedCard === index) {
                    cardElement.classList.add('selected');
                }
                
                if (isSelling && index === sellingCardIndex) {
                    cardElement.classList.add('selling');
                }
                
                const timer = document.createElement('div');
                timer.className = 'hold-timer';
                cardElement.appendChild(timer);
                
                cardElement.addEventListener('mousedown', () => startHold(index));
                cardElement.addEventListener('touchstart', () => startHold(index));
                cardElement.addEventListener('mouseup', () => endHold(index));
                cardElement.addEventListener('mouseleave', cancelHold);
                cardElement.addEventListener('touchend', () => endHold(index));
                
                inventory.appendChild(cardElement);
            });
        }
        
        // Начало удержания карты
        function startHold(index) {
            tapStartTime = Date.now();
            sellingCardIndex = index;
            
            holdTimers[index] = setTimeout(() => {
                prepareToSell(index);
            }, 1000);
            
            const cardElement = document.querySelector(`.inventory-card[data-index="${index}"]`);
            if (cardElement) {
                const timer = cardElement.querySelector('.hold-timer');
                timer.style.width = '100%';
                timer.style.transition = 'width 1s linear';
            }
        }
        
        // Подготовка к продаже
        function prepareToSell(index) {
            isSelling = true;
            sellingCardIndex = index;
            renderInventory();
            
            setTimeout(() => {
                if (isSelling && sellingCardIndex === index) {
                    sellCard(index);
                }
            }, 300);
        }
        
        // Завершение удержания
        function endHold(index) {
            const tapDuration = Date.now() - tapStartTime;
            
            if (holdTimers[index]) {
                clearTimeout(holdTimers[index]);
                delete holdTimers[index];
            }
            
            const cardElement = document.querySelector(`.inventory-card[data-index="${index}"]`);
            if (cardElement) {
                const timer = cardElement.querySelector('.hold-timer');
                timer.style.width = '0%';
                timer.style.transition = 'none';
            }
            
            if (tapDuration < 1000 && !isSelling) {
                selectCard(index);
            }
            
            isSelling = false;
            sellingCardIndex = null;
        }
        
        // Отмена удержания
        function cancelHold() {
            Object.values(holdTimers).forEach(timer => clearTimeout(timer));
            holdTimers = {};
            
            isSelling = false;
            sellingCardIndex = null;
            renderInventory();
        }
        
        // Выбор карты
        function selectCard(index) {
            selectedCard = index;
            document.getElementById('selected-card-name').textContent = gameState.cards[index].name;
            renderInventory();
        }
        
        // Продажа карты
        function sellCard(index) {
            if (index >= 0 && index < gameState.cards.length) {
                const card = gameState.cards[index];
                const price = sellPrices[card.rarity] || 0;
                
                gameState.money += price;
                gameState.cards.splice(index, 1);
                
                if (selectedCard === index) selectedCard = null;
                else if (selectedCard > index) selectedCard--;
                
                updateUI();
                renderInventory();
                saveGame();
            }
        }
        
        // Размещение карты на блок
        function placeCard(blockIndex) {
            if (selectedCard === null) return;
            
            if (gameState.placedCards[blockIndex]) {
                removeCard(blockIndex);
            }
            
            gameState.placedCards[blockIndex] = gameState.cards[selectedCard];
            gameState.cards.splice(selectedCard, 1);
            selectedCard = null;
            document.getElementById('selected-card-name').textContent = '';
            
            updateUI();
            renderBlocks();
            renderInventory();
            saveGame();
        }
        
        // Удаление карты из блока
        function removeCard(blockIndex) {
            if (gameState.placedCards[blockIndex] && gameState.cards.length < gameState.maxCards) {
                gameState.cards.push(gameState.placedCards[blockIndex]);
                gameState.placedCards[blockIndex] = null;
                
                updateUI();
                renderBlocks();
                renderInventory();
                saveGame();
            } else if (gameState.cards.length >= gameState.maxCards) {
                alert('Инвентарь полон! Купите больше слотов.');
            }
        }
        
        // Покупка пачки
        function buyPack(packType) {
            const pack = packs[packType];
            
            if (gameState.money < pack.price) {
                alert('Недостаточно денег!');
                return;
            }
            
            if (gameState.cards.length >= gameState.maxCards) {
                alert('Инвентарь полон! Купите больше слотов.');
                return;
            }
            
            gameState.money -= pack.price;
            
            if (packType === 'small') gameState.smallPacksOpened++;
            if (packType === 'big') gameState.bigPacksOpened++;
            if (packType === 'ultra') gameState.ultraPacksOpened++;
            
            updateUI();
            checkQuestCompletion();
            
            const packSize = Math.floor(Math.random() * (pack.size.max - pack.size.min + 1)) + pack.size.min;
            
            currentPack = pack;
            cardsToOpen = packSize;
            cardsOpened = 0;
            
            document.getElementById('pack-info').textContent = `Открываете ${getPackName(packType)} пачку (осталось: ${packSize} карт)`;
            document.getElementById('pack-opening').style.display = 'flex';
            
            openNextCard();
        }
        
        // Получение названия пачки
        function getPackName(packType) {
            switch(packType) {
                case 'small': return 'маленькую';
                case 'big': return 'большую';
                case 'premium': return 'премиум';
                case 'ultra': return 'ультра';
                case 'omega': return 'ОМЕГА';
                case 'ruby': return 'Рубин';
                case 'ppp': return 'СЕКРЕТНУЮ';
                default: return '';
            }
        }
        
        // Открытие следующей карты
        function openNextCard() {
            if (cardsOpened >= cardsToOpen) {
                finishOpening();
                return;
            }
            
            const packCard = document.getElementById('pack-card');
            packCard.innerHTML = '';
            packCard.style.animation = 'none';
            void packCard.offsetWidth;
            packCard.style.animation = 'cardReveal 0.5s forwards';
            
            const card = getRandomCard(currentPack.cards);
            
            if (card.chance < 1) {
                gameState.rareCardsFound++;
                checkQuestCompletion();
            }
            
            const nameElement = document.createElement('div');
            nameElement.textContent = card.name;
            nameElement.style.fontWeight = 'bold';
            nameElement.style.fontSize = '18px';
            nameElement.style.marginBottom = '10px';
            
            const rarityElement = document.createElement('div');
            rarityElement.textContent = getRarityName(card.rarity);
            rarityElement.style.fontSize = '14px';
            rarityElement.style.marginBottom = '10px';
            
            const incomeElement = document.createElement('div');
            incomeElement.textContent = `Доход: +${card.income}¢/сек`;
            incomeElement.style.fontSize = '14px';
            
            packCard.className = `pack-card card ${card.rarity}`;
            packCard.appendChild(nameElement);
            packCard.appendChild(rarityElement);
            packCard.appendChild(incomeElement);
            
            gameState.cards.push(card);
            cardsOpened++;
            
            document.getElementById('pack-info').textContent = `Открываете ${getPackName(getPackType(currentPack))} пачку (осталось: ${cardsToOpen - cardsOpened} карт)`;
            updateUI();
            saveGame();
        }
        
        // Получение типа пачки
        function getPackType(pack) {
            for (const type in packs) {
                if (packs[type] === pack) return type;
            }
            return null;
        }
        
        // Получение названия редкости
        function getRarityName(rarity) {
            switch(rarity) {
                case 'common': return 'Обычная';
                case 'rare': return 'Редкая';
                case 'epic': return 'Эпическая';
                case 'legendary': return 'Легендарная';
                case 'mythic': return 'Мифическая';
                case 'secret': return 'SECRET';
                case 'divine': return 'БОЖЕСТВЕННАЯ';
                default: return '';
            }
        }
        
        // Завершение открытия пачки
        function finishOpening() {
            document.getElementById('pack-opening').style.display = 'none';
            renderInventory();
        }
        
        // Продолжить открытие
        function continueOpening() {
            openNextCard();
        }
        
        // Получение случайной карты
        function getRandomCard(cardPool) {
            const totalChance = cardPool.reduce((sum, card) => sum + card.chance, 0);
            let random = Math.random() * totalChance;
            
            for (const card of cardPool) {
                if (random < card.chance) {
                    return {...card};
                }
                random -= card.chance;
            }
            
            return {...cardPool[0]};
        }
        
        // Покупка блока
        function buyBlock() {
            if (gameState.money < gameState.blockPrice) {
                alert('Недостаточно денег!');
                return;
            }
            
            gameState.money -= gameState.blockPrice;
            gameState.blocks++;
            gameState.blocksUpgraded++;
            gameState.placedCards.push(null);
            gameState.blockPrice = Math.floor(gameState.blockPrice * 1.5);
            
            checkQuestCompletion();
            updateUI();
            renderBlocks();
            saveGame();
        }
        
        // Покупка слота
        function buyCardSlot() {
            if (gameState.money < gameState.slotPrice) {
                alert('Недостаточно денег!');
                return;
            }
            
            gameState.money -= gameState.slotPrice;
            gameState.maxCards++;
            gameState.slotsUpgraded++;
            gameState.slotPrice = Math.floor(gameState.slotPrice * 1.05);
            
            checkQuestCompletion();
            updateUI();
            saveGame();
        }
        
        // Пассивный доход
        function passiveIncome() {
            let income = 0;
            
            gameState.placedCards.forEach(card => {
                if (card) income += card.income;
            });
            
            if (income > 0) {
                gameState.money += income;
                updateUI();
                saveGame();
            }
        }
        
        // Обновление таймера квестов
        function updateQuestTimer() {
            if (gameState.currentQuest && !gameState.questCompleted) return;
            
            if (gameState.questTimer > 0) {
                gameState.questTimer--;
                
                const minutes = Math.floor(gameState.questTimer / 60);
                const seconds = gameState.questTimer % 60;
                
                document.getElementById('quest-timer').textContent = 
                    `До нового квеста: ${minutes}:${seconds < 10 ? '0' + seconds : seconds}`;
            } else {
                document.getElementById('get-quest-btn').disabled = false;
                document.getElementById('quest-timer').textContent = 'Можно взять новый квест';
            }
            
            saveGame();
        }
        
        // Обработчик кнопки квеста
        function handleQuestButton() {
            if (gameState.currentQuest && gameState.questCompleted) {
                completeQuest();
            } else {
                getNewQuest();
            }
        }
        
        // Получение нового квеста
        function getNewQuest() {
            if (gameState.currentQuest && !gameState.questCompleted) {
                alert('Сначала завершите текущий квест!');
                return;
            }
            
            if (gameState.questTimer > 0) {
                alert('Подождите, пока таймер квеста истечет!');
                return;
            }
            
            const random = Math.random() * 100;
            let questChance;
            
            if (random < 20) questChance = 1;
            else if (random < 40) questChance = 2;
            else if (random < 60) questChance = 3;
            else if (random < 80) questChance = 4;
            else if (random < 95) questChance = 5;
            else questChance = 6;
            
            const quest = quests.find(q => q.id === questChance);
            gameState.currentQuest = {...quest};
            gameState.questCompleted = false;
            gameState.questTimer = 120;
            
            document.getElementById('get-quest-btn').disabled = true;
            updateQuestUI();
            saveGame();
        }
        
        // Обновление интерфейса квеста
        function updateQuestUI() {
            const questElement = document.getElementById('current-quest');
            
            if (gameState.currentQuest) {
                const progress = gameState.currentQuest.progress(gameState);
                questElement.innerHTML = `
                    <strong>${gameState.currentQuest.name}</strong><br>
                    ${gameState.currentQuest.description}<br>
                    ${progress}
                    ${gameState.questCompleted ? '<br><strong>Готово! Нажмите "Взять квест" для награды</strong>' : ''}
                `;
                
                document.getElementById('get-quest-btn').textContent = 
                    gameState.questCompleted ? 'Получить награду' : 'Взять квест у Джона';
            } else {
                questElement.textContent = 'Нет активного квеста';
                document.getElementById('get-quest-btn').textContent = 'Взять квест у Джона';
            }
        }
        
        // Проверка выполнения квеста
        function checkQuestCompletion() {
            if (!gameState.currentQuest || gameState.questCompleted) return;
            
            if (gameState.currentQuest.condition(gameState)) {
                gameState.questCompleted = true;
                updateQuestUI();
                saveGame();
            }
        }
        
        // Завершение квеста и получение награды
        function completeQuest() {
            if (!gameState.currentQuest || !gameState.questCompleted) {
                alert('Нет выполненного квеста!');
                return;
            }
            
            const reward = gameState.currentQuest.reward;
            gameState.diamonds += reward.diamonds;
            
            showNotification(`Квест выполнен! Получено ${reward.diamonds} алмазов`);
            
            gameState.currentQuest = null;
            gameState.questCompleted = false;
            gameState.questTimer = 120;
            
            updateUI();
            saveGame();
        }
        
        // Покупка мутации
        function buyMutation(type) {
            let cost, mutationName;
            
            switch(type) {
                case 'golden':
                    cost = 10;
                    mutationName = 'Золотая мутация';
                    break;
                case 'diamond':
                    cost = 35;
                    mutationName = 'Алмазная мутация';
                    break;
                default:
                    return;
            }
            
            if (gameState.diamonds < cost) {
                alert(`Недостаточно алмазов для ${mutationName}!`);
                return;
            }
            
            gameState.diamonds -= cost;
            gameState.mutations[type]++;
            
            selectedMutation = type;
            mutationApplying = true;
            
            showNotification(`Выберите карту для применения ${mutationName}`);
            
            updateUI();
            renderBlocks();
            saveGame();
        }
        
        // Покупка улучшения за алмазы
        function buyUpgrade(type) {
            let cost, upgradeName, amount;
            
            switch(type) {
                case 'slots':
                    cost = 5;
                    upgradeName = '+2 слота';
                    amount = 2;
                    break;
                case 'blocks':
                    cost = 10;
                    upgradeName = '+2 блока';
                    amount = 2;
                    break;
                default:
                    return;
            }
            
            if (gameState.diamonds < cost) {
                alert(`Недостаточно алмазов для ${upgradeName}!`);
                return;
            }
            
            gameState.diamonds -= cost;
            
            if (type === 'slots') {
                gameState.maxCards += amount;
                gameState.slotsUpgraded += amount;
            } else {
                gameState.blocks += amount;
                gameState.blocksUpgraded += amount;
                for (let i = 0; i < amount; i++) {
                    gameState.placedCards.push(null);
                }
            }
            
            showNotification(`Улучшение "${upgradeName}" приобретено!`);
            
            checkQuestCompletion();
            updateUI();
            renderBlocks();
            saveGame();
        }
        
        // Применение мутации к карте
        function applyMutation(blockIndex) {
            if (!selectedMutation || !gameState.placedCards[blockIndex]) return;

            const card = gameState.placedCards[blockIndex];
            
            // Если уже есть такая же мутация - удаляем
            if (card.mutation === selectedMutation) {
                if (card.originalIncome !== undefined) {
                    card.income = card.originalIncome;
                    delete card.originalIncome;
                }
                delete card.mutation;
                showNotification(`Мутация "${getMutationName(selectedMutation)}" удалена с карты "${card.name}"!`);
            } 
            // Если другая мутация - заменяем
            else {
                // Удаляем предыдущую мутацию если есть
                if (card.mutation) {
                    if (card.originalIncome !== undefined) {
                        card.income = card.originalIncome;
                        delete card.originalIncome;
                    }
                    delete card.mutation;
                }
                
                // Удаляем временные эффекты
                if (card.tempMutation) {
                    const event = events.find(e => e.id === card.tempMutation);
                    if (event) event.endEffect(card);
                    delete card.tempMutation;
                }

                // Применяем новую мутацию
                card.originalIncome = card.income;
                switch(selectedMutation) {
                    case 'golden':
                        card.income *= 5;
                        card.mutation = 'golden';
                        break;
                    case 'diamond':
                        card.income *= 15;
                        card.mutation = 'diamond';
                        break;
                }
                showNotification(`Мутация "${getMutationName(selectedMutation)}" применена к карте "${card.name}"!`);
            }

            selectedMutation = null;
            mutationApplying = false;
            updateUI();
            renderBlocks();
            saveGame();
        }

        // Получение названия мутации
        function getMutationName(mutationType) {
            switch(mutationType) {
                case 'golden': return 'Золотая';
                case 'diamond': return 'Алмазная';
                default: return '';
            }
        }
        
        // Проверка на случайное событие
        function checkForRandomEvent() {
            if (gameState.placedCards.length === 0) return;
            if (gameState.eventActive) return;

            const totalChance = events.reduce((sum, e) => sum + e.chance, 0);
            let random = Math.random() * totalChance;
            let selectedEvent = null;

            for (const event of events) {
                if (random < event.chance) {
                    selectedEvent = event;
                    break;
                }
                random -= event.chance;
            }

            if (!selectedEvent || selectedEvent.id === 'nothing') return;

            gameState.eventActive = selectedEvent.id;
            showNotification(`Начинается ${selectedEvent.name}!`, selectedEvent.color);

            const weatherEffect = document.getElementById('weather-effect');
            weatherEffect.className = `weather-effect ${selectedEvent.effectClass}`;
            weatherEffect.style.display = 'block';

            // Применяем эффект сразу ко всем подходящим картам
            gameState.placedCards.forEach(card => {
                if (card && !card.mutation) { // Не применяем к картам с постоянными мутациями
                    selectedEvent.effect(card);
                }
            });

            // Устанавливаем интервал для новых эффектов
            gameState.eventIntervalId = setInterval(() => {
                applyEventEffect(selectedEvent);
            }, selectedEvent.interval * 1000);
            
            gameState.eventTimer = setTimeout(() => {
                endCurrentEvent();
                showNotification(`${selectedEvent.name} закончился.`, selectedEvent.color);
            }, selectedEvent.duration * 1000);
            
            renderBlocks();
            saveGame();
        }

        // Применение эффекта к случайной карте
        function applyEventEffect(event) {
            const activeCards = gameState.placedCards.filter(card => 
                card !== null && !card.mutation // Только карты без постоянных мутаций
            );
            
            if (activeCards.length === 0) return;
            
            const randomIndex = Math.floor(Math.random() * activeCards.length);
            const card = activeCards[randomIndex];
            
            // Удаляем предыдущий временный эффект если есть
            if (card.tempMutation) {
                const prevEvent = events.find(e => e.id === card.tempMutation);
                if (prevEvent) prevEvent.endEffect(card);
            }
            
            // Применяем новый эффект
            event.effect(card);
            
            showNotification(`${event.name} усиливает карту "${card.name}"!`, event.color);
            
            renderBlocks();
            saveGame();
        }

        // Завершение события
        function endCurrentEvent() {
            if (!gameState.eventActive) return;
            
            const event = events.find(e => e.id === gameState.eventActive);
            if (!event) return;
            
            // Удаляем все эффекты этого события
            gameState.placedCards.forEach(card => {
                if (card && card.tempMutation === event.id) {
                    event.endEffect(card);
                }
            });
            
            // Очищаем таймеры
            if (gameState.eventIntervalId) {
                clearInterval(gameState.eventIntervalId);
                gameState.eventIntervalId = null;
            }
            
            if (gameState.eventTimer) {
                clearTimeout(gameState.eventTimer);
                gameState.eventTimer = null;
            }
            
            // Скрываем эффект погоды
            document.getElementById('weather-effect').style.display = 'none';
            gameState.eventActive = null;
            
            renderBlocks();
            saveGame();
        }

        // Показать уведомление
        function showNotification(message, color = '#333') {
            const notification = document.createElement('div');
            notification.className = 'event-notification';
            notification.textContent = message;
            notification.style.backgroundColor = color;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }
        
        // Запуск игры при загрузке
        window.onload = initGame;
    </script>
</body>
</html>
